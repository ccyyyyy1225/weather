# -*- coding: utf-8 -*-
"""HW4.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-bBhSHSakkMWpHBjzLnY_XX2eGL75C2S
"""

# Commented out IPython magic to ensure Python compatibility.
# %pip install -q requests streamlit pandas plotly

import json
import requests

# ä¸­å¤®æ°£è±¡ç½²è¾²æ¥­æ°£è±¡é å ± APIï¼ˆF-A0010-001ï¼‰
url = "https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/F-A0010-001?Authorization=CWA-E5768D09-F706-4753-B388-9C6A8905AB97&downloadType=WEB&format=JSON"

# ç™¼é€è«‹æ±‚
response = requests.get(url)

# å°‡å›å‚³å…§å®¹è½‰ç‚º JSON
data = response.json()

# æå–ä¸»è³‡æ–™éƒ¨åˆ†ï¼ˆå¯è¦–ç‚ºä¸€é€±è¾²æ¥­æ°£è±¡é å ±ï¼‰
main_data = data["cwaopendata"]["resources"]["resource"]["data"]["agrWeatherForecasts"]

# ä½¿ç”¨ json.dumps é¡¯ç¤ºæ•´é«”çµæ§‹ï¼ˆä¿ç•™ä¸­æ–‡ï¼Œæ’ç‰ˆæ¸…æ™°ï¼‰
print(json.dumps(main_data, indent=4, ensure_ascii=False))

import json
import requests

# API ä¾†æºï¼ˆä½ æä¾›çš„ URLï¼‰
url = "https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/F-A0010-001?Authorization=CWA-3DE12743-8E82-4A80-9524-AC203C066CA5&downloadType=WEB&format=JSON"

# ç™¼é€è«‹æ±‚å–å¾—è³‡æ–™
response = requests.get(url)
data = response.json()

# æ“·å–å…­å¤§åœ°å€è³‡æ–™
locations = data["cwaopendata"]["resources"]["resource"]["data"]["agrWeatherForecasts"]["weatherForecasts"]["location"]

# çµæœå„²å­˜
temperature_extremes = {}

# åˆ†ææ¯å€‹åœ°å€çš„æº«åº¦
for loc in locations:
    region_name = loc["locationName"]
    max_temps = [int(day["temperature"]) for day in loc["weatherElements"]["MaxT"]["daily"]]
    min_temps = [int(day["temperature"]) for day in loc["weatherElements"]["MinT"]["daily"]]

    # æ‰¾å‡ºæœ€é«˜æº«èˆ‡æœ€ä½æº«åŠå…¶å°æ‡‰æ—¥æœŸ
    max_temp = max(max_temps)
    min_temp = min(min_temps)
    max_date = loc["weatherElements"]["MaxT"]["daily"][max_temps.index(max_temp)]["dataDate"]
    min_date = loc["weatherElements"]["MinT"]["daily"][min_temps.index(min_temp)]["dataDate"]

    temperature_extremes[region_name] = {
        "æœ€é«˜æ°£æº«": {
            "æ—¥æœŸ": max_date,
            "æº«åº¦": f"{max_temp}Â°C"
        },
        "æœ€ä½æ°£æº«": {
            "æ—¥æœŸ": min_date,
            "æº«åº¦": f"{min_temp}Â°C"
        }
    }

# è¼¸å‡º JSON çµæ§‹ï¼Œè§€å¯Ÿè³‡æ–™ï¼ˆç¬¦åˆä½œæ¥­è¦æ±‚ï¼‰
print(json.dumps(temperature_extremes, indent=2, ensure_ascii=False))

response = requests.get(url)
data = response.json()

import sqlite3
# --- 2. å»ºç«‹ SQLite è³‡æ–™åº«èˆ‡è³‡æ–™è¡¨ ---
conn = sqlite3.connect("data.db")
cursor = conn.cursor()


# å»ºç«‹ Tableï¼šTemperatureForecasts
cursor.execute("""
CREATE TABLE IF NOT EXISTS TemperatureForecasts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    regionName TEXT,
    dataDate TEXT,
    mint INTEGER,
    maxt INTEGER
)
""")

# æ¸…ç©ºèˆŠè³‡æ–™ï¼ˆé¿å…é‡è¤‡ï¼‰
cursor.execute("DELETE FROM TemperatureForecasts")

# æ’å…¥è³‡æ–™
for loc in locations:
    region = loc["locationName"]
    maxT_list = loc["weatherElements"]["MaxT"]["daily"]
    minT_list = loc["weatherElements"]["MinT"]["daily"]

    for i in range(len(maxT_list)):
        date = maxT_list[i]["dataDate"]
        maxt = int(maxT_list[i]["temperature"])
        mint = int(minT_list[i]["temperature"])
        cursor.execute("""
            INSERT INTO TemperatureForecasts (regionName, dataDate, mint, maxt)
            VALUES (?, ?, ?, ?)
        """, (region, date, mint, maxt))

conn.commit()

conn.close()

import sqlite3
import pandas as pd

# é€£ç·šåˆ°è³‡æ–™åº«
conn = sqlite3.connect("data.db")

# æŸ¥è©¢è³‡æ–™è¡¨æ‰€æœ‰å…§å®¹
df = pd.read_sql_query("SELECT * FROM TemperatureForecasts", conn)

# é¡¯ç¤ºè³‡æ–™
print(df)

conn.close()

import sqlite3
import pandas as pd

# é€£æ¥ SQLite è³‡æ–™åº«
conn = sqlite3.connect("data.db")
cursor = conn.cursor()

# æŸ¥è©¢æ‰€æœ‰åœ°å€åç¨±
df_regions = pd.read_sql_query("SELECT DISTINCT regionName FROM TemperatureForecasts", conn)
print("âœ… æ‰€æœ‰åœ°å€åç¨±ï¼š")
print(df_regions)

# æŸ¥è©¢ä¸­éƒ¨åœ°å€çš„æ‰€æœ‰æ°£æº«è³‡æ–™
df_central = pd.read_sql_query("SELECT * FROM TemperatureForecasts WHERE regionName='ä¸­éƒ¨åœ°å€'", conn)
print("\nâœ… ä¸­éƒ¨åœ°å€æ°£æº«è³‡æ–™ï¼š")
print(df_central)

conn.close()

# app.py
import streamlit as st
import sqlite3
import pandas as pd
import matplotlib.pyplot as plt

import matplotlib.pyplot as plt
plt.rcParams['font.family'] = 'Microsoft JhengHei'  # å¾®è»Ÿæ­£é»‘é«”ï¼Œæ”¯æ´ä¸­æ–‡


# è¨­å®šæ¨™é¡Œ
st.title("ğŸŒ¤ï¸ ä¸€é€±æ°£æº«é å ±æŸ¥è©¢ç³»çµ±")

# é€£ç·šè‡³ SQLite è³‡æ–™åº«
conn = sqlite3.connect("data.db")
cursor = conn.cursor()

# å–å¾—æ‰€æœ‰åœ°å€åç¨±
regions = pd.read_sql_query("SELECT DISTINCT regionName FROM TemperatureForecasts", conn)
region_list = regions["regionName"].tolist()

# åœ°å€ä¸‹æ‹‰é¸å–®
selected_region = st.selectbox("è«‹é¸æ“‡åœ°å€", region_list)

# æŸ¥è©¢æ‰€é¸åœ°å€çš„æ°£æº«è³‡æ–™
query = """
SELECT dataDate, mint, maxt
FROM TemperatureForecasts
WHERE regionName = ?
ORDER BY dataDate
"""
df = pd.read_sql_query(query, conn, params=(selected_region,))

# é¡¯ç¤ºè¡¨æ ¼
st.subheader(f"{selected_region} ä¸€é€±æ°£æº«è³‡æ–™è¡¨")
st.dataframe(df)

# é¡¯ç¤ºæŠ˜ç·šåœ–
st.subheader("æº«åº¦è¶¨å‹¢åœ–ï¼ˆæœ€é«˜èˆ‡æœ€ä½æ°£æº«ï¼‰")
fig, ax = plt.subplots()
ax.plot(df["dataDate"], df["maxt"], marker='o', label="æœ€é«˜æ°£æº«")
ax.plot(df["dataDate"], df["mint"], marker='o', label="æœ€ä½æ°£æº«")
ax.set_ylabel("æ°£æº« (Â°C)")
ax.set_xlabel("æ—¥æœŸ")
ax.set_title(f"{selected_region} ä¸€é€±æ°£æº«è¶¨å‹¢")
plt.xticks(rotation=45)
plt.grid(True)
plt.legend()
st.pyplot(fig)

conn.close()